{% extends "main.html" %}
{% load static %}
{% block title %} Item Listing {% endblock title %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/main.css' %}" type="text/css">

<!-- alert system if ebay API calls fail -->
{% if messages %}
{% for message in messages %}
<div
        class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-{{ message.tags }}{% endif %} alert-dismissible fade show"
        role="alert"
>
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}
{% endif %}

<!-- form -->
<section class="py-5">
  <div class="container px-3 px-lg-4 mt-5 w-50">
    <div class="text-center">
      <h1>Add Items via eBay Search</h1>

      <!-- ✅ Search Form -->
      <form id="ebay-search-form" method="POST">
        {% csrf_token %}
        {% for field in form %}
        <div class="form-group">
          <label class="form-label fw-semibold">{{ field.label }}</label>
          {{ field }}
          {% if field.errors %}
          <div class="text-danger small mt-1">
            {{ field.errors|striptags }}
          </div>
          {% endif %}
        </div>
        {% endfor %}
        <div style="margin-top:20px;">
          <button type="submit" class="btn btn-primary w-100">Submit</button>
        </div>
      </form>

      <!-- ✅ Loading Indicator (always in DOM, not in conditional) -->
      <div id="loading-indicator" class="text-center my-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Searching eBay for items...</p>
      </div>

      <div style="padding-bottom: 10%">
        <a href="{% url 'item_listing' %}" class="btn btn-primary">Back to item listing</a>
      </div>
    </div>
  </div>

  <!-- ✅ Keep results section separate -->
  {% if recent_items %}
  <section class="py-5" style="background-color: #2d3238">
    <div class="container px-4 px-lg-5">
      <h2 class="fw-bold mb-4 text-white">Search Results</h2>
      <div class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4">

        {% for item in recent_items %}
        <div class="col mb-4">
          <div class="card h-100 bg-dark border border-secondary shadow-sm">

            <!-- ✅ eBay Link Icon in top-right -->
            <a href="{{ item.item_url }}" target="_blank"
               class="ebay-link-icon position-absolute top-0 end-0 m-2"
               title="View on eBay">
              <img src="{% static 'img/arrow_link.png' %}" alt="eBay" style="width:36px; height:36px;">
            </a>

              <img class="card-img-top" src="{{ item.image_url }}" alt="{{ item.title }}" style="height: 200px; object-fit: cover;">
            <div class="card-body p-3 text-white">
              <h5 class="fw-bolder mb-2">{{ item.title|truncatewords:8 }}</h5>
              <p class="small text-muted mb-3">{{ item.description|truncatewords:10 }}</p>
              <!-- PASSES SOME DATA TO AJAX FROM RECENT_ITEMS TEMP LIST IN VIEW -->
              <button
                      class="btn btn-sm btn-outline-light w-100 add-item-btn"
                      data-title="{{ item.title }}"
                      data-description="{{ item.description }}"
                      data-image="{{ item.image_url }}"
                      data-item-id="{{ item.item_id }}"
                      data-item-url="{{ item.item_url }}"
                      data-seller-id="{{ item.seller_id }}"
              >
                Add Item
              </button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>
  {% endif %}
</section>

<!-- ✅ JavaScript -->
<script>
  // Show spinner when submitting eBay search form
  const ebayForm = document.getElementById("ebay-search-form");
  const loadingIndicator = document.getElementById("loading-indicator");

  ebayForm.addEventListener("submit", () => {
    loadingIndicator.style.display = "block";
  });

  // Handle "Add Item" AJAX calls
  document.querySelectorAll(".add-item-btn").forEach(btn => {
    btn.addEventListener("click", async function() {
      const title = this.dataset.title;
      const description = this.dataset.description;
      const image = this.dataset.image;
      // This pulls from the button post above with
      // data-title =
      // data-description = ...
      // and item-id converts to itemId for some reason, same w itemUrl
      const item_id = this.dataset.itemId;
      const item_url = this.dataset.itemUrl;
      const seller_id = this.dataset.sellerId;

      this.disabled = true;
      this.textContent = "Adding...";

      const response = await fetch("{% url 'ajax_add_item' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({ title, description, image_url: image, item_id, item_url, seller_id })
      });

      if (response.ok) {
        const data = await response.json();
        if (data.error) {
          this.textContent = data.error;
          this.classList.add("btn-warning");
        } else {
          this.textContent = "Added!";
          this.classList.remove("btn-outline-light");
          this.classList.add("btn-success");
        }
      } else {
        this.textContent = "Error";
        this.classList.add("btn-danger");
      }
    });
  });
</script>

{% endblock content %}
