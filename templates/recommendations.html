{% extends "main.html" %}
{% load static %}

{% block title %}AI Recommendations Â· Best Dressed{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Your Personalized Recommendations</h2>
    
    <!-- Loading Indicator -->
    <div id="loading-indicator" class="text-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Generating your personalized fashion recommendations...</p>
    </div>
    
    <!-- Recommendations Container -->
    <div id="recommendations-container" style="display: none;">
        <div id="recommendations-content" class="mt-4">
            <!-- AI recommendations will be inserted here -->
        </div>
    </div>
    
    <!-- Error Container -->
    <div id="error-container" class="alert alert-danger" style="display: none;" role="alert">
        <strong>Error:</strong> <span id="error-message"></span>
    </div>
</div>

<script>
    // Fetch recommendations when page loads
    document.addEventListener('DOMContentLoaded', function() {
        fetchRecommendations();
    });
    
    function fetchRecommendations() {
        fetch('{% url "generate_recommendations_ajax" %}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Failed to generate recommendations');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Hide loading indicator
                document.getElementById('loading-indicator').style.display = 'none';
                
                // Show and populate recommendations
                document.getElementById('recommendations-container').style.display = 'block';
                document.getElementById('recommendations-content').innerHTML = formatRecommendations(data.recommendations);
            } else {
                throw new Error(data.error || 'Unknown error occurred');
            }
        })
        .catch(error => {
            // Hide loading indicator
            document.getElementById('loading-indicator').style.display = 'none';
            
            // Show error message
            document.getElementById('error-container').style.display = 'block';
            document.getElementById('error-message').textContent = error.message;
        });
    }
    
    function formatRecommendations(recommendations) {
        // Convert line breaks to HTML paragraphs for better formatting
        const formatted = recommendations
            .split('\n')
            .filter(line => line.trim() !== '')
            .map(line => `<p>${escapeHtml(line)}</p>`)
            .join('');
        
        return formatted || '<p>No recommendations available at this time.</p>';
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}